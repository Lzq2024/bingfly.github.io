<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="lzq">
    
    
    
    
    
    
    <title>Nginx | 冰的技术专栏</title>
    <link href="http://bingfly.top" rel="prefetch" />

    
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/aos.css">
<link rel="stylesheet" href="/css/style.css">

    
<script src="/js/jquery.min.js"></script>

    
<script src="/js/bootstrap.min.js"></script>

    
<script src="/js/aos.js"></script>

    
<script src="/js/highslide/highslide-full.min.js"></script>

    
<link rel="stylesheet" href="/js/highslide/highslide.css">

    <style type="text/css">
        @media (max-width: 768px) {
            body {
                background-color: #f0f0f0;
                background: url('/imgs/xsbg.gif');
                background-attachment: fixed;
            }
        }
    </style>
    
    <!--<script type="text/javascript">
      if (document.images) {
        var avatar = new Image();
        avatar.src = '/imgs/avatar.jpg'
        var previews = 'preview1.jpg,preview2.jpg,preview3.jpg,preview4.jpg,preview5.jpg,preview6.jpg,preview7.jpg,preview8.jpg,preview9.jpg,preview10.jpg,preview11.jpg,preview12.jpg,preview13.jpg,preview14.jpg,preview15.jpg'.split(',')
        var previewsPreLoad = []
        for(var i = 0; i < length; i++) {
          previewsPreLoad.push(new Image())
          previewsPreLoad[previewsPreLoad.length - 1].src = '/imgs/preview' + previews[i]
        }
      }
    </script>-->
<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <!-- 背景轮播图功能 -->
    <section class="hidden-xs">
    <ul class="cb-slideshow">
        <li><span>天若</span></li>
        <li><span>有情</span></li>
        <li><span>天亦老</span></li>
        <li><span>我为</span></li>
        <li><span>长者</span></li>
        <li><span>续一秒</span></li>
    </ul>
</section>
    <!-- 欧尼酱功能, 谁用谁知道 -->
    
    <div class="gal-menu gal-dropdown">
    <div class="circle" id="gal">
        <div class="ring">
            <a href="http://bingfly.top" class="menuItem" style="left: 50%; top: 15%;">首页</a>
            
            <a class="menuItem" style="left: 80.3109%; top: 32.5%;">下一页</a>
            
            <a href="/archives" class="menuItem" style="left: 80.3109%; top: 67.5%;">归档</a>
            <a href="/about" class="menuItem" style="left: 50%; top: 85%;">关于</a>
            <a href="/message" class="menuItem" style="left: 19.6891%; top: 67.5%;">留言板</a>

            
            <a class="menuItem" style="left: 19.6891%; top: 32.5%;">上一页</a>
            
        </div>
        <audio id="audio" src="/imgs/oni.mp3"></audio>
    </div>
</div>
    
    <header class="navbar navbar-inverse" id="gal-header">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target=".bs-navbar-collapse"
                    aria-expanded="false">
                <span class="fa fa-lg fa-reorder"></span>
            </button>
            <a href="http://bingfly.top">
                
                <style>
                    #gal-header .navbar-brand {
                        height: 54px;
                        line-height: 24px;
                        font-size: 28px;
                        opacity: 1;
                        background-color: rgba(0,0,0,0);
                        text-shadow: 0 0 5px #fff,0 0 10px #fff,0 0 15px #fff,0 0 20px #228DFF,0 0 35px #228DFF,0 0 40px #228DFF,0 0 50px #228DFF,0 0 75px #228DFF;
                    }
                </style>
                <!-- 这里使用文字(navbar_text or config.title) -->
                <div class="navbar-brand">冰的技术专栏</div>
                
            </a>
        </div>
        <div class="collapse navbar-collapse bs-navbar-collapse">
            <ul class="nav navbar-nav" id="menu-gal">
                
                
                <li class="">
                    <a href="/">
                        <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                
                
                <li class="">
                    <a href="/archives">
                        <i class="fa fa-archive"></i>归档
                    </a>
                </li>
                
                
                
                
                <li class="dropdown">
                    <!-- TODO 添加hover dropdown效果 -->
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false" data-hover="dropdown">
                        <i class="fa fa-list"></i>分类
                    </a>
                    <ul class="dropdown-menu">
                        
                        
                        <li>
                            <a href="/categories/hexo-%E5%8D%9A%E5%AE%A2/">hexo+博客</a>
                        </li>
                        
                        <li>
                            <a href="/categories/Python%E9%9D%A2%E8%AF%95/">Python面试</a>
                        </li>
                        
                        <li>
                            <a href="/categories/Apache/">Apache</a>
                        </li>
                        
                        
                        <li>
                            <a href="/categories">...</a>
                        </li>
                        
                        
                    </ul>
                </li>
                
                
                
                
                
                <li class="dropdown">
                    <!-- TODO 添加hover dropdown效果 -->
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false" data-hover="dropdown">
                        <i class="fa fa-tags"></i>标签
                    </a>
                    <ul class="dropdown-menu">
                        
                        
                        <li>
                            <a href="/tags/Python/">Python</a>
                        </li>
                        
                        <li>
                            <a href="/tags/Apache/">Apache</a>
                        </li>
                        
                        <li>
                            <a href="/tags/Shell/">Shell</a>
                        </li>
                        
                        
                        <li>
                            <a href="/tags">...</a>
                        </li>
                        
                        
                    </ul>
                </li>
                
                
                
                
                <li class="">
                    <a href="/about">
                        <i class="fa fa-user"></i>关于我
                    </a>
                </li>
                
                
            </ul>
        </div>
    </div>
</header>
    <div id="gal-body">
        <div class="container">
            <div class="row">
                <div class="col-md-8 gal-right" id="mainstay">
                    
<article class="article well article-body" id="article">
    <div class="breadcrumb">
        <i class="fa fa-home"></i>
        <a href="http://bingfly.top">冰的技术专栏</a>
        >
        <span>Nginx</span>
    </div>
    <!-- 大型设备详细文章 -->
    <div class="hidden-xs">
        <div class="title-article">
            <h1>
                <a href="/2024/06/13/%E6%80%BB%E7%BB%93/8%E3%80%81Nginx/">Nginx</a>
            </h1>
        </div>
        <div class="tag-article">
            
            <span class="label label-gal">
                <i class="fa fa-tags"></i>
                
                <a href="/tags/Nginx/">Nginx</a>
                
            </span>
            
            <span class="label label-gal">
                <i class="fa fa-calendar"></i> 2024-06-13
            </span>
            
        </div>
    </div>
    <!-- 小型设备详细文章 -->
    <div class="visible-xs">
        <center>
            <div class="title-article">
                <h4>
                    <a href="/2024/06/13/%E6%80%BB%E7%BB%93/8%E3%80%81Nginx/">Nginx</a>
                </h4>
            </div>
            <p>
                <i class="fa fa-calendar"></i> 2024-06-13
            </p>
            <p>
                
                <i class="fa fa-tags"></i>
                
                <a href="/tags/Nginx/">Nginx</a>
                
                
                
            </p>
        </center>
    </div>
    <div class="content-article">
        <p>[TOC]</p>
<h1 id="一、Nginx"><a href="#一、Nginx" class="headerlink" title="一、Nginx"></a>一、Nginx</h1><h2 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h2><p>Nginx是一个 Web 服务器和反向代理服务器用于 HTTP、HTTPS、SMTP、POP3 和 IMAP 协议。因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名</p>
<h2 id="1、工作原理"><a href="#1、工作原理" class="headerlink" title="1、工作原理"></a>1、工作原理</h2><p>Nginx 由内核和模块组成。</p>
<p>Nginx 本身做的工作实际很少，当它接到一个 HTTP 请求时， 它仅仅是通过查找配置文件将此次请求映射到一个 location 模块，而此 location 中所配 置的各个指令则会启动不同的模块去完成工作，因此模块可以看做 Nginx 真正的劳动工作者。 </p>
<p>通常一个 location 中的指令会涉及一个 handler 模块和多个 filter 模块（当然，多个 location 可以复用同一个模块）。handler 模块负责处理请求，完成响应内容的生成，而 filter 模块对响应内容进行处理。 用户根据自己的需要所开发的模块都属于第三方模块。正是有了这么多模块的支撑， Nginx 的功能才会如此强大。 </p>
<h2 id="2、Nginx模块"><a href="#2、Nginx模块" class="headerlink" title="2、Nginx模块"></a>2、Nginx模块</h2><p><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/nginx/">https://www.w3cschool.cn/nginx/</a></p>
<p><img src="https://gitee.com/julyjo/blogimage/raw/master/img/20210127104536.png" alt="img"></p>
<p>vim &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</p>
<p>vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</p>
<p><strong>nginx模块分为两种，官方和第三方</strong>，我们通过命令 nginx -V 查看 nginx已经安装的模块！<br>如果需要添加某个模块，需要将工作目录切换至nginx的源码包中，执行“nginx -V”命令查看之前配置时的选项进行复制，然后增加需要添加的模块配置项，进行配置并编译，将新生成的nginx命令覆盖掉原有的nginx命令，然后重载nginx服务，即可实现在线添加模块。</p>
<p>[root@localhost ~]# nginx -V</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx version: nginx/1.15.9</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_stub_status_module</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Nginx模块名称</th>
<th>模块作用</th>
</tr>
</thead>
<tbody><tr>
<td>ngx_http_access_module</td>
<td>四层基于IP的访问控制，可以通过匹配客户端源IP地址进行限制</td>
</tr>
<tr>
<td>ngx_http_auth_basic_module</td>
<td>状态页，使用basic机制进行用户认证，在编译安装nginx的时候需要添加编译参数–withhttp_stub_status_module，否则配置完成之后监测会是提示语法错误</td>
</tr>
<tr>
<td>ngx_http_stub_status_module</td>
<td>状态统计模块</td>
</tr>
<tr>
<td>ngx_http_gzip_module</td>
<td>文件的压缩功能</td>
</tr>
<tr>
<td>ngx_http_gzip_static_module</td>
<td>静态压缩模块</td>
</tr>
<tr>
<td>ngx_http_ssl_module</td>
<td>nginx 的https 功能</td>
</tr>
<tr>
<td><strong>ngx_http_rewrite_module</strong></td>
<td>实现URL地址重写，URL看起来更规范、合理</td>
</tr>
<tr>
<td><strong>ngx_http_referer_module</strong></td>
<td>防盗链功能，基于访问安全考虑</td>
</tr>
<tr>
<td>ngx_http_proxy_module</td>
<td>将客户端的请求以http协议转发至指定服务器进行处理</td>
</tr>
<tr>
<td>ngx_stream_proxy_module</td>
<td>tcp负载，将客户端的请求以tcp协议转发至指定服务器处理</td>
</tr>
<tr>
<td>ngx_http_fastcgi_module</td>
<td>将客户端对php的请求以fastcgi协议转发至指定服务器助理</td>
</tr>
<tr>
<td>ngx_http_uwsgi_module</td>
<td>将客户端对Python的请求以uwsgi协议转发至指定服务器处理</td>
</tr>
<tr>
<td>ngx_http_headers_module</td>
<td>可以实现对头部报文添加指定的key与值</td>
</tr>
<tr>
<td>ngx_http_upstream_module</td>
<td>负载均衡模块，提供服务器分组转发、权重分配、状态监测、调度算法等高级功能</td>
</tr>
<tr>
<td>ngx_stream_upstream_module</td>
<td>后端服务器分组转发、权重分配、状态监测、调度算法等高级功能</td>
</tr>
<tr>
<td>ngx_http_fastcgi_module</td>
<td>实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理</td>
</tr>
<tr>
<td>ngx_http_flv_module</td>
<td>为flv伪流媒体服务端提供支持</td>
</tr>
</tbody></table>
<p>1、Nginx 的模块从结构上分为核心模块、基础模块和第三方模块</p>
<p>核心模块：HTTP 模块、EVENT 模块和 MAIL 模块；</p>
<p>基础模块：HTTP Access 模块、HTTP FastCGI 模块、HTTP Proxy 模块和 HTTP Rewrite 模块；</p>
<p>第三方模块：HTTP Upstream Request Hash 模块、Notice 模块和 HTTP Access Key 模 块。</p>
<p>2、Nginx 的模块从功能上分为如下三类：</p>
<p>Handlers（处理器模块）：此类模块直接处理请求，并进行输出内容和修改 headers 信息等操作。Handlers 处理器模块一般只能有一个； </p>
<p>Filters（过滤器模块）：此类模块主要对其他处理器模块输出的内容进行修改操作，最后由 Nginx 输出；Proxies（代理类模块）：此类模块是 Nginx 的 HTTP </p>
<p>Upstream 之类的模块，这些模块主要与后端一些服务比如 FastCGI 等进行交互，实现服务代理和负载均衡等功能。 </p>
<h4 id="Nginx-rewrite概述"><a href="#Nginx-rewrite概述" class="headerlink" title="Nginx rewrite概述"></a>Nginx rewrite概述</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/July_jojo/article/details/109739494">https://blog.csdn.net/July_jojo/article/details/109739494</a></p>
<h2 id="3、Nginx-的进程模型"><a href="#3、Nginx-的进程模型" class="headerlink" title="3、Nginx 的进程模型"></a>3、Nginx 的进程模型</h2><p> 在工作方式上，Nginx 分为单工作进程和多工作进程两种模式。 </p>
<p>1、在单工作进程模式下，除主进程外，还有一个工作进程，工作进程是单线程的； </p>
<p>2、在多工作进程模式下，每个工作进程包含多个线程。Nginx 默认为单工作进程模式。 </p>
<p>Nginx 在启动后，会有一个 master 进程和多个 worker 进程。 </p>
<p>master 进程主要用来管理 worker 进程，主要包含：接收来自外界的信号，向各 worker 进程发送信号，监控 worker 进程的运行状态，当 worker 进程退出后(异常情况下)，会自动 重新启动新的 worker 进程。 master 进程充当整个进程组与用户的交互接口，同时对进程进行监护。它不需要处理网络事件，不负责业务的执行，只会通过管理worker 进程来实现重启服务、平滑升级、更换日志文件、配置文件实时生效等功能。 </p>
<h1 id="二、Nginx优点"><a href="#二、Nginx优点" class="headerlink" title="二、Nginx优点"></a>二、Nginx优点</h1><h2 id="1、优点"><a href="#1、优点" class="headerlink" title="1、优点"></a>1、优点</h2><p>跨平台、配置简单。</p>
<p>非阻塞、高并发连接</p>
<p>处理 2-3 万并发连接数，官方监测能支持 5 万并发。</p>
<p>内存消耗小</p>
<p>开启 10 个 Nginx 才占 150M 内存</p>
<p>成本低廉，且开源。</p>
<p>稳定性高，宕机的概率非常小。</p>
<p><strong>主要功能：</strong></p>
<p>1）正向、反向代理 </p>
<p>2）负载均衡、分流 </p>
<p>2）充当一个虚拟主机（绑定host）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构，它的正则规则比HAProxy更为强大和灵活，这也是它目前广泛流行的主要原因之一，Nginx单凭这点可利用的场合就远多于LVS了。</span><br><span class="line"></span><br><span class="line">2、Nginx对网络稳定性的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势之一</span><br><span class="line"></span><br><span class="line">3、Nginx安装和配置比较简单，测试起来比较方便，它基本能把错误用日志打印出来。</span><br><span class="line"></span><br><span class="line">4、可以承担高负载压力且稳定，在硬件不差的情况下一般能支撑几万次的并发量，负载度较小    （比LVS）</span><br><span class="line"></span><br><span class="line">5、Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测。比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障，Nginx会把上传切到另一台服务器重新处理</span><br><span class="line"></span><br><span class="line">6、Nginx不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的Web应用服务器。LNMP也是近几年非常流行的web架构，在高流量的环境中稳定性也很好。</span><br><span class="line"></span><br><span class="line">7、Nginx现在作为Web反向加速缓存越来越成熟了，速度比传统的Squid服务器更快，可以用作为反向代理加速器。</span><br><span class="line"></span><br><span class="line">8、Nginx可作为中层反向代理使用，这一层面Nginx基本上无对手，唯一可以对比Nginx的就只有 lighttpd了，不过 lighttpd目前还没有做到Nginx完全的功能，配置也不那么清晰易读，社区资料也远远没Nginx活跃。</span><br><span class="line"></span><br><span class="line">9、Nginx也可作为静态网页和图片服务器，这方面的性能也无对手。还有Nginx社区非常活跃，第三方模块也很多。</span><br></pre></td></tr></table></figure>

<p><strong>缺点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Nginx的缺点是：</span><br><span class="line">Nginx仅能支持http、https和Email协议，这样就在适用范围上面小些，这个是它的缺点。</span><br><span class="line">对后端服务器的健康检查，只支持通过端口来检测，不支持通过url来检测。不支持Session的直接保持，但能通过ip_hash来解决。</span><br></pre></td></tr></table></figure>



<h2 id="2、正向代理和反向代理的区别"><a href="#2、正向代理和反向代理的区别" class="headerlink" title="2、正向代理和反向代理的区别"></a>2、正向代理和反向代理的区别</h2><h3 id="1）正向代理"><a href="#1）正向代理" class="headerlink" title="1）正向代理"></a>1）正向代理</h3><p>是一个位于客户端和目标服务器之间的服务器，为了从目标服务器取得内容，客户端向代理发送一个请求并指定目标服务器，然后代理向目标服务器转交请求并将获得的内容返回给客户端。代理服务器和客户端处于同一个局域网内。</p>
<p>比如说fanqiang。我知道我要访问谷歌，于是我就告诉它让它帮我转发。</p>
<h3 id="2）反向代理"><a href="#2）反向代理" class="headerlink" title="2）反向代理"></a>2）反向代理</h3><p>up</p>
<p>实际运行方式是代理服务器接受网络上的连接请求。它将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给网络上请求连接的客户端 。代理服务器和目标服务器处于同一个局域网内。</p>
<p>比如说我要访问taobao，对我来说不知道图片、json、css 是不是同一个服务器返回回来的，但是我不关心，是反向代理 处理的，我不知道目标服务器。</p>
<p>反向代理配置：vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">   log_format  main  &#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;;</span><br><span class="line">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class="line">    </span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">        server 192.168.195.149:6443;</span><br><span class="line">        server 192.168.195.131:6443;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">                listen 6443;</span><br><span class="line">                proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="3、Nginx如何处理HTTP请求的？"><a href="#3、Nginx如何处理HTTP请求的？" class="headerlink" title="3、Nginx如何处理HTTP请求的？"></a>3、Nginx如何处理HTTP请求的？</h2><p>它结合多进程机制（单线程）和异步非阻塞方式。</p>
<h3 id="1）多进程机制（单线程）"><a href="#1）多进程机制（单线程）" class="headerlink" title="1）多进程机制（单线程）"></a>1）多进程机制（单线程）</h3><p>服务器每当收到一个客户端时，就有 服务器主进程 （ master process ）生成一个 子进程（ worker process ）出来和客户端建立连接进行交互，直到连接断开，该子进程就结束了。</p>
<h3 id="2）异步非阻塞机制"><a href="#2）异步非阻塞机制" class="headerlink" title="2）异步非阻塞机制"></a>2）异步非阻塞机制</h3><p>每个工作进程 使用 异步非阻塞方式 ，可以处理 多个客户端请求 。 运用了epoll模型，提供了一个队列，排队解决。</p>
<p>当某个 工作进程 接收到客户端的请求以后，调用 IO 进行处理，如果不能立即得到结果，就去 处理其他请求 （即为 非阻塞 ）；而 客户端 在此期间也 无需等待响应 ，可以去处理其他事情（即为 异步 ）。</p>
<p>当 IO 返回时，就会通知此 工作进程 ；该进程得到通知，暂时 挂起 当前处理的事务去 响应客户端请求</p>
<h2 id="4、Nginx的master和worker"><a href="#4、Nginx的master和worker" class="headerlink" title="4、Nginx的master和worker"></a>4、Nginx的master和worker</h2><p>这跟Nginx的多进程、单线程有关。（一个进程只有一个主线程）。</p>
<p>为什么要用单线程？</p>
<p>采用单线程来异步非阻塞处理请求（管理员可以配置Nginx主进程的工作进程的数量），不会为每个请求分配cpu和内存资源，节省了大量资源，同时也减少了大量的CPU的上下文切换，所以才使得Nginx支持更高的并发。</p>
<p>简单过程：</p>
<p>主程序 Master process 启动后，通过一个 for 循环来 接收 和 处理外部信号 ；</p>
<p>主进程通过 fork() 函数产生 worker 子进程 ，每个子进程执行一个 for循环来实现Nginx服务器对事件的接收和处理 。</p>
<p>详细过程：</p>
<p>1、Nginx 在启动后，会有一个 master 进程和多个相互独立的 worker 进程。 2、master 接收来自外界的信号，先建立好需要 listen 的 socket（listenfd） 之后，然后再 fork 出多个 worker 进程，然后向各worker进程发送信号，每个进程都有可能来处理这个连接。 3、所有 worker 进程的 listenfd 会在新连接到来时变得可读 ，为保证只有一个进程处理该连接，所有 worker 进程在注册 listenfd 读事件前抢占 accept_mutex ，抢到互斥锁的那个进程注册 listenfd 读事件 ，在读事件里调用 accept 接受该连接。 4、当一个 worker 进程在 accept 这个连接之后，就开始读取请求、解析请求、处理请求，产生数据后，再返回给客户端 ，最后才断开连接。</p>
<h2 id="5、Nginx-常用命令"><a href="#5、Nginx-常用命令" class="headerlink" title="5、Nginx 常用命令"></a>5、Nginx 常用命令</h2><p>启动 nginx 。</p>
<p>停止 nginx -s stop 或 nginx -s quit 。</p>
<p>重启 nginx -s reload 或 service nginx reload 。</p>
<p>重载指定配置文件 .nginx -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf 。</p>
<p>查看 nginx 版本 nginx -v 。</p>
<h2 id="6、Nginx状态码"><a href="#6、Nginx状态码" class="headerlink" title="6、Nginx状态码"></a>6、Nginx状态码</h2><p><a target="_blank" rel="noopener" href="https://www.php.cn/course/1020.html">https://www.php.cn/course/1020.html</a></p>
<h3 id="1）3开头"><a href="#1）3开头" class="headerlink" title="1）3开头"></a>1）3开头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">301：请求资源已被永久移动位置 </span><br><span class="line">302：请求的资源现在临时从不同的URL响应请求 </span><br><span class="line">303：查看其他，对应当前请求的响应可以在另一个URI上被找到</span><br><span class="line">305：使用代理。被请求的资源必须通过指定的代理才能被访问 </span><br><span class="line">307：临时跳转。被请求的资源在临时从不同的URL响应请求</span><br></pre></td></tr></table></figure>

<h3 id="2）4开头"><a href="#2）4开头" class="headerlink" title="2）4开头"></a>2）4开头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">400：错误请求。</span><br><span class="line">402：需要付款。该状态码是为了将来可能需求而预留的，用于一些数字货币或者微支付</span><br><span class="line">403：禁止访问。服务器已理解请求，但是拒绝执行它</span><br><span class="line">404：找不到对象，请求失败，资源不存在</span><br><span class="line">406：不可接受的，请求的资源的内容特性无法满足请求头中的条件，因而无法生成响应实体</span><br><span class="line">408：请求超时；</span><br><span class="line">409：冲突。由于和被请求的资源的当前状态之间存在冲突，请求无法完成；</span><br><span class="line">410：遗失的。被请求的资源在服务器上已经不再可用，而且没有任何已知的转发地址；</span><br><span class="line">413：响应实体太大。服务器拒绝处理当前请求，请求超过服务器所能处理和允许的最大值。</span><br><span class="line">417：期望失败。在请求头 Expect 中指定的预期内容无法被服务器满足；</span><br><span class="line">418：我是一个茶壶。超文本咖啡罐控制协议，但是并没有被实际的HTTP服务器实现</span><br><span class="line">420：方法失效。</span><br><span class="line">422：不可处理的实体。请求格式正确，但是由于含有语义错误，无法响应；</span><br></pre></td></tr></table></figure>

<h3 id="3）5开头"><a href="#3）5开头" class="headerlink" title="3）5开头"></a>3）5开头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">500：Internal Server Error 内部服务错误，比如脚本错误，编程语言语法错误。</span><br><span class="line">502：Bad Gateway错误，网关错误。比如服务器当前连接太多，响应太慢，页面素材太多、带宽慢。</span><br><span class="line">503：Service Temporarily Unavailable，服务不可用，web服务器不能处理HTTP请求，可能是临时超载或者是服务器进行停机维护。</span><br><span class="line">504：Gateway timeout 网关超时，程序执行时间过长导致响应超时，例如程序需要执行20秒，而nginx最大响应等待时间为10秒，这样就会出现超时。</span><br></pre></td></tr></table></figure>



<h2 id="7、Nginx-压缩"><a href="#7、Nginx-压缩" class="headerlink" title="7、Nginx 压缩"></a>7、Nginx 压缩</h2><p>为什么要开启压缩？</p>
<p><strong>开启nginx gzip压缩后</strong>，图片、css、js等静态资源的大小会减小，可节省带宽，提高传输效率，但是会消耗CPU资源。</p>
<p>开启：</p>
<p>​    # 开启gzip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip off;</span><br></pre></td></tr></table></figure>

<p>​    # 启用gzip压缩的最小文件，小于设置值的文件将不会压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_min_length 1k;</span><br></pre></td></tr></table></figure>

<p>​    # gzip 压缩级别，1-9，数字越大压缩的越好，也越占用CPU时间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_comp_level 1;</span><br></pre></td></tr></table></figure>

<p>​    # 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;</span><br></pre></td></tr></table></figure>



<h2 id="8、Nginx-和-Apache、Tomcat-之间的不同点"><a href="#8、Nginx-和-Apache、Tomcat-之间的不同点" class="headerlink" title="8、Nginx 和 Apache、Tomcat 之间的不同点"></a>8、Nginx 和 Apache、Tomcat 之间的不同点</h2><p>1、Nginx&#x2F;Apache 是Web Server,而Apache Tomact是一个servlet container </p>
<p>2、tomcat可以对jsp进行解析，nginx和apache只是web服务器，可以简单理解为只能提供html静态文件服务。</p>
<h4 id="Nginx和Apache区别："><a href="#Nginx和Apache区别：" class="headerlink" title="Nginx和Apache区别："></a>Nginx和Apache区别：</h4><p>1）Nginx轻量级，同样起web 服务，比apache占用更少的内存及资源 。</p>
<p>2）Nginx 抗并发，nginx 处理请求是异步非阻塞的，而apache 则是阻塞型的，在高并发下nginx 能保持低资源低消耗高性能 。</p>
<p>3）Nginx提供负载均衡，可以做做反向代理，前端服务器</p>
<p>4）Nginx多进程单线程，异步非阻塞；Apache多进程同步，阻塞。</p>
<h2 id="9、Nginx动静态资源分离"><a href="#9、Nginx动静态资源分离" class="headerlink" title="9、Nginx动静态资源分离"></a>9、Nginx动静态资源分离</h2><p>动态资源、静态资源分离，是让动态网站里的动态网页根据一定规则把不变的资源和经常变的资源区分开来</p>
<p>比如说 js、css、hrml从A服务器返回。图片 从B服务器返回，其他请求从Tomcat服务器C返回。</p>
<p>后台应用分开部署，提高用户访问静态代码的速度。而且现在还有CDN服务，不需要限制于服务器的带宽。</p>
<h2 id="10、ngx-http-upstream-module"><a href="#10、ngx-http-upstream-module" class="headerlink" title="10、ngx_http_upstream_module"></a>10、ngx_http_upstream_module</h2><p>ngx_http_upstream_module模块用于将多个服务器定义成服务器组，可通过fastcgi传递、proxy传递、uwsgi传递、memcached传递和scgi传递指令来引用的服务器组。</p>
<p>比如访问<a target="_blank" rel="noopener" href="http://www.a.com/">www.a.com</a> 缓存+调度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    proxy_cache_path /var/cache/nginx/proxy_cache levels=1:2:2 keys_zone=proxycache:20m inactive=120s max_size=1g; #缓存</span><br><span class="line">    upstream mysqlsrvs&#123;</span><br><span class="line">        ip_hash; #源地址hash调度方法 写了backup就不可用</span><br><span class="line">        server 172.18.99.1:80 weight=2; #weight权重</span><br><span class="line">        server 172.18.99.2:80;          #标记down，配合ip_hash使用，实现灰度发布</span><br><span class="line">        server 172.18.99.3:80 backup;   #backup将服务器标记为“备用”，即所有服务器均不可用时才启用 </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    server_name www.a.com;</span><br><span class="line">    proxy_cache proxycache;</span><br><span class="line">    proxy_cache_key $request_uri;</span><br><span class="line">    proxy_cache_valid 200 302 301 1h;</span><br><span class="line">    proxy_cache_valid any 1m;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://mysqlsrvs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="11、限流了解吗，怎么限流的？"><a href="#11、限流了解吗，怎么限流的？" class="headerlink" title="11、限流了解吗，怎么限流的？"></a>11、限流了解吗，怎么限流的？</h2><p>Nginx 提供两种限流方式，一是控制速率，二是控制并发连接数。</p>
<h4 id="1、控制速率"><a href="#1、控制速率" class="headerlink" title="1、控制速率"></a>1、控制速率</h4><p>ngx_http_limit_req_module 模块提供了漏桶算法(leaky bucket)，可以限制单个IP的请求处理频率。</p>
<p>如：</p>
<p><strong>1.1 正常限流：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">limit_req_zone 192.168.1.1 zone=myLimit:10m rate=5r/s;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">location / &#123;</span><br><span class="line">limit_req zone=myLimit;</span><br><span class="line">rewrite / http://www.hac.cn permanent;</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数解释：</p>
<p>key: 定义需要限流的对象。</p>
<p>zone: 定义共享内存区来存储访问信息。</p>
<p>rate: 用于设置最大访问速率。</p>
<p>表示基于客户端192.168.1.1进行限流，定义了一个大小为10M，名称为myLimit的内存区，用于存储IP地址访问信息。rate设置IP访问频率，rate&#x3D;5r&#x2F;s表示每秒只能处理每个IP地址的5个请求。Nginx限流是按照毫秒级为单位的，也就是说1秒处理5个请求会变成每200ms只处理一个请求。如果200ms内已经处理完1个请求，但是还是有有新的请求到达，这时候Nginx就会拒绝处理该请求。</p>
<p><strong>1.2 突发流量限制访问频率</strong></p>
<p>上面rate设置了 5r&#x2F;s，如果有时候流量突然变大，超出的请求就被拒绝返回503了，突发的流量影响业务就不好了。</p>
<p>这时候可以加上burst 参数，一般再结合 nodelay 一起使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">location / &#123;</span><br><span class="line">limit_req zone=myLimit burst=20 nodelay;</span><br><span class="line">rewrite / http://www.hac.cn permanent;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>burst&#x3D;20 nodelay 表示这20个请求立马处理，不能延迟，相当于特事特办。不过，即使这20个突发请求立马处理结束，后续来了请求也不会立马处理。burst&#x3D;20 相当于缓存队列中占了20个坑，即使请求被处理了，这20个位置这只能按 100ms一个来释放。</p>
<h4 id="2、控制并发连接数"><a href="#2、控制并发连接数" class="headerlink" title="2、控制并发连接数"></a>2、控制并发连接数</h4><p>ngx_http_limit_conn_module 提供了限制连接数功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone $binary_remote_addr zone=perip:10m;</span><br><span class="line">limit_conn_zone $server_name zone=perserver:10m;</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    limit_conn perip 10;</span><br><span class="line">    limit_conn perserver 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>limit_conn perip 10 作用的key 是 $binary_remote_addr，表示限制单个IP同时最多能持有10个连接。</p>
<p>limit_conn perserver 100 作用的key是 $server_name，表示虚拟主机(server) 同时能处理并发连接的总数。</p>
<p><strong>注</strong>：limit_conn perserver 100 作用的key是 $server_name，表示虚拟主机(server) 同时能处理并发连接的总数。</p>
<p><strong>拓展：</strong></p>
<p>如果不想做限流，还可以设置白名单：</p>
<p>利用 Nginx ngx_http_geo_module 和 ngx_http_map_module 两个工具模块提供的功能。</p>
<p>##定义白名单ip列表变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">geo $limit &#123;</span><br><span class="line">    default 1;</span><br><span class="line">    10.0.0.0/8 0;</span><br><span class="line">    192.168.0.0/10 0;</span><br><span class="line">    81.56.0.35 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">map $limit $limit_key &#123;</span><br><span class="line">    0 &quot;&quot;;</span><br><span class="line">    1 $binary_remote_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p># 正常限流设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $limit_key zone=myRateLimit:10m rate=10r/s;</span><br></pre></td></tr></table></figure>

<p>geo 对于白名单 将返回0，不限流；其他IP将返回1，进行限流。</p>
<p>具体参考：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_geo_module.html">http://nginx.org/en/docs/http/ngx_http_geo_module.html</a></p>
<p>除此之外：</p>
<p>ngx_http_core_module 还提供了限制数据传输速度的能力(即常说的下载速度)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /flv/ &#123;</span><br><span class="line">    flv;</span><br><span class="line">    limit_rate_after 500m;</span><br><span class="line">    limit_rate       50k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对每个请求，表示客户端下载前500m的大小时不限速，下载超过了500m后就限速50k&#x2F;s。</p>
<h2 id="12、nginx重定向，重写URL"><a href="#12、nginx重定向，重写URL" class="headerlink" title="12、nginx重定向，重写URL"></a>12、nginx重定向，重写URL</h2><p>URL重写有利于网站首选域的确定，对于同一资源页面多条路径的301重定向有助于URL权重的集中</p>
<p>处理高并发：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/asqi1/article/details/41478111">https://blog.csdn.net/asqi1/article/details/41478111</a></p>
<p>单个Nginx并发尽量不要超过2w，如果你的并发都达到10w了，是时候做DNS分流了，还不行的话，就应该像Google那样直接从网卡驱动层分流了</p>
<h2 id="13、nginx是如何实现高并发的？"><a href="#13、nginx是如何实现高并发的？" class="headerlink" title="13、nginx是如何实现高并发的？"></a>13、nginx是如何实现高并发的？</h2><p>答：nginx之所以可以实现高并发，与它采用的epoll模型有很大的关系。epoll模型采用异步非阻塞的事件处理机制。这种机制可让nginx进程同时监控多个事件。</p>
<p>简单来说，就是异步非阻塞，使用了epoll模型和大量的底层代码优化。如果深入一点的话，就是nginx的特殊进程模型和事件模型的设计，才使其可以实现高并发。</p>
<p>进程模型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">它是采用一个master进程和多个worker进程的工作模式。</span><br><span class="line">1、master进程主要负责收集、分发请求。当一个请求过来时，master拉起一个worker进程负责处理这个请求。；</span><br><span class="line">2、master进程也要负责监控worker的状态，保证高可靠性；</span><br><span class="line">3、worker进程议案设置为和CPU核心数一致或者其二倍。nginx的worker进程和Apache的不一样。apache的进程在同一时间只能处理一个请求，所以它会开启很多个进程，几百甚至几千个。而nginx的worker进程在同一时间可以处理的请求数只受内存限制，因此可以处理更多请求。</span><br></pre></td></tr></table></figure>

<p>事件模型<br>nginx是异步非阻塞的。</p>
<p>一个master进程，多个worker进程，每个worker进程可以处理多个请求。每进来一个request，都会有worker进程去处理。但不是全程的处理，那么处理到的程度就是可能发生阻塞的地方，比如向后端服务器转发request，并等待请求返回。那么，在等待期间，这个处理的worker不会这么傻等着，他会在发送完请求后，注册一个事件：“如果upstream返回了，告诉我一声，我再接着干”。于是它就去休息了，此时，如果再有request进来，它就可以很快再按这种方式处理。而一旦后端服务器返回了，就会触发这个事件，worker才会来接手，这个request才会接着往下走。<br>由于nginx的的这个工作性质决定了每个请求大部分的生命都是在网络传输中，所以实际上花费在nginx 服务器上的时间并不多，这就是它几进程就能解决高并发的秘密所在。</p>
<h2 id="14、使用nginx代理后，获取用户真实ip"><a href="#14、使用nginx代理后，获取用户真实ip" class="headerlink" title="14、使用nginx代理后，获取用户真实ip"></a>14、使用nginx代理后，获取用户真实ip</h2><p>使用nginx转发请求时，应用中获取到的用户ip 都是127.0.0.1，获取真实ip必须重写一些头部才行。通常在WSGI环境中经常使用的变量:REMOTE_ADDR ，在nginx转发时设置头部携带这个变量</p>
<p>nginx设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name _;</span><br><span class="line">    location / &#123;</span><br><span class="line">        ..................</span><br><span class="line">        proxy_pass         http://127.0.0.1:8000/;</span><br><span class="line">        # $host 变量，Host 为变量名 </span><br><span class="line">        proxy_set_header   Host             $host;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;       </span><br><span class="line">        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以从proxy_add_x_forwarded_for中获取到用户的真实IP，</p>
<p>也可以通过后台的程序，从请求的header里获取X-Forwarded-For，然后取起一个值即可，使用正则匹配获取第一个即可，如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	proxy_set_header   Host $host;</span><br><span class="line">	set $Real $proxy_add_x_forwarded_for;</span><br><span class="line">	if (Real ~ ( d+) i. (1d+) i. (sd+) i. (d+),(.*) )&#123;</span><br><span class="line">		set$Real $1.$2.$3.$4;</span><br><span class="line">		&#125;</span><br><span class="line">	proxy_set_header   X-real-ip $Real;</span><br><span class="line">	proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<p>proxy_set_header 和add_header 的区别</p>
<p>区别: proxy_set_header是Nginx设置请求头信息给上游服务器, add_header是Nginx设置响应头信息给浏览器。</p>
<p>proxy_set_header<br>假如Nginx请求上游服务器时，添加额外的请求头，就需要使用proxy_set_header。</p>
<h1 id="三、Nginx的优化"><a href="#三、Nginx的优化" class="headerlink" title="三、Nginx的优化"></a>三、Nginx的优化</h1><p>配置nginx的proxy缓存；</p>
<p>对静态页面开启压缩功能，如br压缩或者gzip压缩；</p>
<p>调整nginx运行工作进程个数，最多开启8个，8个以上话性能就不会再提升了，而且稳定性变得更低，所以8个足够用了；</p>
<p>调整nginx运行CPU的亲和力；</p>
<p>修改nginx最多可打开的文件数，若超过系统限制的最多打开文件数（ulimit -n命令查看系统的最多打开文件数），还需要修改系统默认的文件数；</p>
<p>修改单个worker的最大连接数；</p>
<p>开启高效传输；</p>
<p>设置连接超时时间，以便保护服务器资源，因为建立连接也是需要消耗资源的；</p>
<p>优化fastCGI的一个超时时间，也可以根据实际情况对其配置缓存动态页面；</p>
<p>expires缓存调优，主要针对图片、css、js等元素更改较少的情况下使用。</p>
<p>配置防盗链；</p>
<p>优化内核参数，如进程可以同时打开的最大句柄数；开启tcp重用机制，以便允许TIME_WAIT sockets重新用于新的TCP连接….</p>
<h3 id="1、隐藏版本号"><a href="#1、隐藏版本号" class="headerlink" title="1、隐藏版本号"></a>1、隐藏版本号</h3><p>隐藏Nginx版本号有两种方式：</p>
<p>第一种是修改Nginx源码文件，指定不显示版本号</p>
<p>第二种是修改Nginx的主配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# curl -I http://20.0.0.6   ### 查看网站版本号</span><br><span class="line">HTTP/1.1 200 OK    </span><br><span class="line">Server: nginx/1.15.9                 ### 版本号</span><br><span class="line">Date: Sun, 06 Sep 2020 05:52:47 GMT</span><br></pre></td></tr></table></figure>

<p><strong>1）修改配置文件方式</strong></p>
<p>  将Nginx的配置文件中的server_tokens选项值设置为off，如果有该配置项，加上即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;                                         </span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    server_tokens off;        ###此处新增代码，含义是将版本号关闭  </span><br><span class="line">    </span><br><span class="line">[root@localhost ~]# nginx -t  ### 检查配置是否正常</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# systemctl restart nginx.service  ### 重启服务</span><br></pre></td></tr></table></figure>

<p>测试：然后用Wireshark抓包软件抓包测试一下，版本号还能看到吗</p>
<p><strong>2）设置版本信息</strong></p>
<p>  Nginx源码文件&#x2F;opt&#x2F;nginx-1.15.9&#x2F;src&#x2F;core&#x2F;nginx.h包含了版本信息，可以随意设置，然后重新编译安装，隐藏版本信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi /opt/nginx-1.15.9/src/core/nginx.h </span><br><span class="line">#define NGINX_VERSION      &quot;1.1.1&quot;   ### 修改版本号</span><br><span class="line">#define NGINX_VER          &quot;IIS&quot; NGINX_VERSION   ### 修改服务器类型</span><br><span class="line">[root@localhost ~]# cd /opt/nginx-1.15.9/</span><br><span class="line">[root@localhost nginx-1.15.9]# </span><br><span class="line">./configure \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_stub_status_module</span><br><span class="line"></span><br><span class="line">[root@localhost nginx-1.15.9]# make -j3 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">[root@localhost nginx-1.15.9]# cd /usr/local/nginx/conf/</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# vi nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    server_tokens on;   ### 打开版本号</span><br><span class="line">[root@localhost conf]# systemctl restart nginx.service ###重启</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# curl -I http://20.0.0.6</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: IIS 1.1.1       ### 版本号和服务器类型已经更改</span><br><span class="line">Date: Sun, 06 Sep 2020 06:34:21 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Sun, 06 Sep 2020 06:14:14 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;5f547e36-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>



<h3 id="2、修改用户与组"><a href="#2、修改用户与组" class="headerlink" title="2、修改用户与组"></a>2、修改用户与组</h3><p><strong>1）指定用户与组参数</strong></p>
<p>configure编译过程中指定用户和组参数为nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /opt/nginx-1.15.9/</span><br><span class="line"></span><br><span class="line">[root@localhost nginx-1.15.9]# ./configure \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_stub_status_module</span><br></pre></td></tr></table></figure>

<p><strong>2）配置用户与组</strong></p>
<p>修改Nginx配置文件的Nginx指定用户与组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# cd /usr/local/nginx/conf/</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# vi nginx.conf</span><br><span class="line">user  nginx nginx;         ### 修改用户为nginx，组为nginx</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# ps aux |grep nginx</span><br><span class="line">root      23044  0.0  0.0  20560   628 ?        Ss   02:40   0:00 nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx     23045  0.0  0.0  23100  1396 ?        S    02:40   0:00 nginx: worker process</span><br><span class="line">root      23059  0.0  0.0 112708   976 pts/0    S+   02:41   0:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>重启Nginx查看进程运行情况，主进程由root账户创建，子进程由Nginx创建。</p>
<h3 id="3、配置网页缓存时间"><a href="#3、配置网页缓存时间" class="headerlink" title="3、配置网页缓存时间"></a>3、配置网页缓存时间</h3><p>1、以图片作为缓存对象，上传51xit.jpg图片到&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html的工作目录，访问<a target="_blank" rel="noopener" href="http://20.0.0.6/51xit.jpg%EF%BC%8C%E7%94%A8wireshark%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E6%8A%93%E5%8C%85%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%EF%BC%8C%E6%B2%A1%E6%9C%89%E5%9B%BE%E7%89%87%E7%9A%84%E7%BC%93%E5%AD%98%E4%BF%A1%E6%81%AF%E6%9F%A5%E7%9C%8B%E6%8A%A5%E6%96%87%E6%B2%A1%E6%9C%89%E7%BC%93%E5%AD%98%E4%BF%A1%E6%81%AF">http://20.0.0.6/51xit.jpg，用wireshark工具进行抓包，查看响应报文，没有图片的缓存信息查看报文没有缓存信息</a></p>
<p>2、修改Nginx的配置文件，在新location段加入expires参数，指定缓存的时间1d一天</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line">        location ~ \.(gif|jpg|jepg|png|bmp|ico)$ &#123;</span><br><span class="line">         root html;</span><br><span class="line">         expires 1d;  ### 指定缓存时间1天</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>3、重启Nginx服务，访问wireshark抓包</p>
<p>[root@localhost ~]# systemctl restart nginx  ### 重启nginx服务</p>
<p>测试：在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html里面添加一张51xit.jpg图片，然后wireshark抓包查看一下缓存时间对不对</p>
<h3 id="4、日志分割"><a href="#4、日志分割" class="headerlink" title="4、日志分割"></a>4、日志分割</h3><p>  日志切割 随着Nginx运行时间的增加， 产生的日志也会逐渐增加，为了方便掌握Nginx的运行 状态， 需要时刻关注Nginx日志文件。太大的日志文件对监控是一个大灾难，不便于分析排查，需要定期的进行日志文件的切割。</p>
<p> ##编写脚本&#x2F;opt&#x2F;feng e.sh## </p>
<p>把Nginx的日志文件&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log移动到， 目录&#x2F;var&#x2F;log&#x2F;ng in x下面， 以当前时间做为日志文件的名称， 然后用kill-USR1创建新的日志文件&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log， 最后删除30天之前的日志文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi /opt/fenge.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"># Filename: fenge.sh</span><br><span class="line">d=$(date -d &quot;-1 day&quot; &quot;+%Y%m%d&quot;)</span><br><span class="line">logs_path=&quot;/var/log/nginx&quot;</span><br><span class="line">pid_path=&quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br><span class="line">[ -d $logs_path ] || mkdir -p $logs_path</span><br><span class="line">mv /usr/local/nginx/logs/access.log $&#123;logs_path&#125;/test.com-access.log-$d</span><br><span class="line">kill -USR1 $(cat $pid_path)</span><br><span class="line">find $logs_path -mtime +30 |xargs rm -rf</span><br></pre></td></tr></table></figure>

<p>—————上面解释—————————————————————-</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Filename: fenge.sh</span><br><span class="line">d=$(date -d &quot;-1 day&quot; &quot;+%Y%m%d&quot;)</span><br><span class="line">logs_path=&quot;/var/log/nginx&quot;                        ###分割到nginx目录去</span><br><span class="line">pid_path=&quot;/usr/local/nginx/logs/nginx.pid&quot;       ###重新生成新的日志文件</span><br><span class="line">[ -d $logs_path ] || mkdir -p $logs_path       ###如果没有nginx目录就会创建</span><br><span class="line">mv /usr/local/nginx/logs/access.log $&#123;logs_path&#125;/test.com-access.log-$d   ###把原有路径的日志文件移出来，改成那天的日期名字</span><br><span class="line">kill -USR1 $(cat $pid_path)                            ###结束当时的进程，生成一个新pid，然后生成新的日志文件</span><br><span class="line">find $logs_path -mtime +30 |xargs rm -rf    ###找到30天之前的删除掉</span><br></pre></td></tr></table></figure>

<p>-—————————————————————————————–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chmod +x /opt/fenge.sh  ###给执行权限</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# ./fenge.sh           ### 执行分割脚本</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# ls /var/log/nginx/</span><br><span class="line">test.com-access.lo  test.com-access.log-20200905     ###按日期分割了日志文件</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# cat /usr/local/nginx/logs/access.log   ###原来的位置文件重新创建</span><br><span class="line"></span><br><span class="line">########设置crotab任务，定期执行脚本自动进行日志分割#########</span><br><span class="line">[root@localhost opt]# crontab -e</span><br><span class="line">30 1 * * * /opt/fenge.sh</span><br></pre></td></tr></table></figure>



<h3 id="5、设置连接超时"><a href="#5、设置连接超时" class="headerlink" title="5、设置连接超时"></a>5、设置连接超时</h3><p>在企业网站中，为了避免同一个客户长时间占用连接，造成资源浪费，可设置相应的连 接超时参数， 实现控制连接访问时间。可以修改配置文件nginx.conf， 设置keepalive_timeout 超时时间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line">    keepalive_timeout  65 180;  ### 默认65秒，设置超时180秒</span><br><span class="line">    client_header_timeout 80;</span><br><span class="line">    client_body_timeout 80;</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# systemctl restart nginx  ###重启nginx服务</span><br></pre></td></tr></table></figure>

<p>测试：浏览器输入20.0.0.6，然后wireshark抓包查看一下连接超时时间</p>
<p>##########深入优化##############</p>
<h3 id="6、更改进程数"><a href="#6、更改进程数" class="headerlink" title="6、更改进程数"></a>6、更改进程数</h3><p>  在高并发环境中，需要启动更多的Nginx进程以保证快速响应，用以处理用户的请求，避免造成阻塞。使用ps aux命令查看Nginx运行进程的个数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps aux |grep nginx</span><br><span class="line">root      76128  0.0  0.0  20560   628 ?        Ss   03:26   0:00 nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx     76129  0.0  0.0  23100  1652 ?        S    03:26   0:00 nginx: worker process</span><br><span class="line">root      76201  0.0  0.0 112708   972 pts/0    S+   03:33   0:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>  其中master是Nginx的主进程，开启了1个，worker 是子进程，进程也是开启了1个。</p>
<p>  修改Nginx的配置文件的worker_processes参数， 一般设为CPU的个数或者核数， 在高并发的情况下可设置为CPU个数或者核数的2倍， 可以查看CPU的核数以确定参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat /proc/cpuinfo |grep -c &quot;physical&quot;  ###查看CPU的核数以确定参数。</span><br><span class="line"></span><br><span class="line">8</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">worker_processes  8;   ###根据刚刚查的核数，把数字改成8.</span><br><span class="line"></span><br><span class="line">修改完后，重启服务，使用ps aux查看运行进程数的变化情况。</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ps aux|grep nginx  ### 可以看到现在是8个进程</span><br><span class="line"></span><br><span class="line">root      76329  0.0  0.0  20560   700 ?        Ss   03:40   0:00 nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line">nginx     76330  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76331  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76332  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76333  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76334  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76335  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76336  0.0  0.0  23100  1404 ?        S    03:40   0:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">nginx     76337  0.0  0.0  23100  1404 ?        S    03:40   0:00 n</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="7、配置网页压缩"><a href="#7、配置网页压缩" class="headerlink" title="7、配置网页压缩"></a>7、配置网页压缩</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">    gzip  on;</span><br><span class="line"></span><br><span class="line">    gzip_buffers 4 64k;</span><br><span class="line"></span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line"></span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line"></span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line"></span><br><span class="line">    gzip_vary on;</span><br><span class="line"></span><br><span class="line">    gzip_types text/plain text/javascript application/x-javascript text/css text/xml application/xml application/xml+rss;</span><br></pre></td></tr></table></figure>



<p>###上面的配置解释###</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gzip on：开启gzip压缩输出； </span><br><span class="line"></span><br><span class="line">gzip_min_length 1k：用于设置允许压缩的页面最小字节数；</span><br><span class="line"></span><br><span class="line">gzip_buffers 416k：表示申请4个单位为16k的内存作为压缩结果流缓存，默认值 是申请与原始数据大小相同的内存空间来存储gzip压缩结果； </span><br><span class="line"></span><br><span class="line">Zip_http_version 1.0：用于设置识别http协议版本， 默认是1.1，目前大部分浏览 器已经支持gzip解压，但处理最慢，也比较消耗服务器CPU资源； </span><br><span class="line"></span><br><span class="line">Gzip_comp_level 2：用来指定gzip压缩比， 1压缩比最小， 处理速度最快； 9压缩 比最大，传输速度快，但处理速度最慢，使用默认即可；</span><br><span class="line"></span><br><span class="line">Gzip_types text/plain：压缩类型， 是对哪些网页文档启用压缩功能；</span><br><span class="line"></span><br><span class="line">Gzip_vary on：选项可以让前端的缓存服务器缓存经过gzip压缩的页面</span><br></pre></td></tr></table></figure>



<p>[root@localhost ~]# vi &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;index.html </p>
<h1>xxxxxx</h1>  ###在这里面随便加东西，让index.html大于1k就行
测试：浏览器输入20.0.0.6/index.html，然后wireshark抓包查看一下压缩情况。



<h3 id="8、配置防盗链"><a href="#8、配置防盗链" class="headerlink" title="8、配置防盗链"></a>8、配置防盗链</h3><p>###防盗链需要准备两台主机模拟盗链###</p>
<p>20.0.0.6   <a target="_blank" rel="noopener" href="http://www.51xit.top/">www.51xit.top</a>    源主机</p>
<p>20.0.0.5   <a target="_blank" rel="noopener" href="http://www.52xit.top/">www.52xit.top</a>    盗链主机</p>
<p>### 修改windows的 C:\Windows\System32\drivers\etc\host文件，设置域名和映射关系</p>
<p>20.0.0.6 <a target="_blank" rel="noopener" href="http://www.51xit.top/">www.51xit.top</a> </p>
<p>20.0.0.5 <a target="_blank" rel="noopener" href="http://www.52xit.top/">www.52xit.top</a></p>
<p>###在盗链主机的工作目录编写盗链页面index.html，即盗源主机的图片###</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /usr/local/httpd/htdocs/</span><br><span class="line"></span><br><span class="line">[root@localhost htdocs]# vi index.html </span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;--盗图测试--&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;&lt;h1&gt;盗图页面&lt;/h1&gt;</span><br><span class="line">&lt;img src=http://20.0.0.6/51xit.jpg /&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p>测试：浏览器输入20.0.0.5，查看能不能正常盗链</p>
<p>###在主机配置Nginx防盗链###</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /usr/local/nginx/conf/</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# vi nginx.conf</span><br><span class="line">        location ~* \.(gif|jpg|jepg|png|bmp|ico)$ &#123;</span><br><span class="line">         valid_referers none blocked *.51xit.top 51xit.top;</span><br><span class="line">         if ($invalid_referer) &#123;</span><br><span class="line">           rewrite ^/ https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=202451072,4165552475&amp;fm=26&amp;gp=0.jpg;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost conf]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>测试：浏览器输入20.0.0.5，查看能不能防止盗链！！！</p>
<h3 id="9、FPM参数优化"><a href="#9、FPM参数优化" class="headerlink" title="9、FPM参数优化"></a>9、FPM参数优化</h3><p>####################安装PHP环境#####</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum -y install \</span><br><span class="line">libjpeg \</span><br><span class="line">libjpeg-devel \</span><br><span class="line">libpng libpng-devel \</span><br><span class="line">freetype freetype-devel \</span><br><span class="line">libxml2 \</span><br><span class="line">libxml2-devel \</span><br><span class="line">zlib zlib-devel \</span><br><span class="line">curl curl-devel \</span><br><span class="line">openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>#######上传php-7.1.10.tar.bz2包到opt目录下#####</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">tar xjvf php-7.1.10.tar.bz2</span><br><span class="line">cd php-7.1.10</span><br><span class="line">./configure \</span><br><span class="line">--prefix=/usr/local/php \</span><br><span class="line">--with-apxs2=/usr/local/httpd/bin/apxs \</span><br><span class="line">--with-mysql-sock=/usr/local/mysql/mysql.sock \</span><br><span class="line">--with-mysqli \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-curl \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-png-dir \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-openssl \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--enable-xml \</span><br><span class="line">--enable-session \</span><br><span class="line">--enable-ftp \</span><br><span class="line">--enable-pdo \</span><br><span class="line">--enable-tokenizer \</span><br><span class="line">--enable-zip</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">make -j3 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">cp php.ini-development /usr/local/php/lib/php.ini</span><br><span class="line"></span><br><span class="line">vi /usr/local/php/lib/php.ini</span><br><span class="line"></span><br><span class="line">mysqli.default_socket = /usr/local/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line"></span><br><span class="line">[root@localhost php-7.1.10]# /usr/local/php/bin/php -m //验证安装的模块</span><br><span class="line"></span><br><span class="line">[root@localhost php-7.1.10]# vi /etc/httpd.conf //在合适位置新增</span><br><span class="line"></span><br><span class="line">AddType application/x-httpd-php .php    ###添加</span><br><span class="line">AddType application/x-httpd-php-source .phps   ###添加</span><br><span class="line">&lt;IfModule dir_module&gt; </span><br><span class="line">    DirectoryIndex index.php index.html  ###找到这个添加</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">[root@localhost php-7.1.10]# rm -f /usr/local/httpd/htdocs/index.html ###删除</span><br><span class="line"></span><br><span class="line">[root@localhost php-7.1.10]#  vi /usr/local/httpd/htdocs/index.php  ###创建新的</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">[root@localhost php-7.1.10]# systemctl restart httpd.service</span><br><span class="line">测试：20.0.0.6</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>#####FPM参数优化###</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost php-7.1.10]# cd /usr/local/php/etc/php-fpm.d</span><br><span class="line"></span><br><span class="line">[root@localhost etc]# vi www.conf</span><br><span class="line">pm=dynamic</span><br><span class="line">pm.max_children=20</span><br><span class="line">pm.start_servers=5</span><br><span class="line">pm.min_spare_servers=2</span><br><span class="line">pm.max_spare_servers=8</span><br></pre></td></tr></table></figure>

<p>FPM启动时有5个进程，最小空闲2个进程，最大空闲8个进程，最多可以有20个进程存在。</p>
<p>一、pm.max_children多大合适?</p>
<p>  这个值原则上是越大越好， php-cgi的进程多了就会处理的很快， 排队的请求就会很少。</p>
<p>设置”max children”也需要根据服务器的性能进行设定。</p>
<p>计算方式如下：</p>
<p>  一般来说一台服务器正常情况下每一个php-cgi所耗费的内存在20M~30M左右， 因此我的”max_children”我设置成40个，</p>
<p>  20M*40&#x3D;800M也就是说在峰值的时候所有PHP-CGI所耗内存在800M以内， 低于我的有效内存2Gb。</p>
<p>  而如果我的”max_children”设置的较小， 比如5-10个， 那么php-cgi就会“很累“， 处理速度也很慢， 等待的时间也较长，占用的CPU也很高。</p>
<p>  如果长时间没有得到处理的请求就会出现504 Gateway Time-out这个错误， 而正在处理的很累的那几个php-cgi如果遇到了问题就会出现502Bad gateway这个错误。</p>
<p>  max_children较好的设置方式根据req&#x2F;s(吞吐率， 单位时间里服务器处理的最大请求数， 单位req&#x2F;s) 来设置， 若程序是100D req&#x2F;s的处理能力， 那么就设置100比较好， 这是动态来调整的。</p>
<h3 id="10、内核优化"><a href="#10、内核优化" class="headerlink" title="10、内核优化"></a>10、内核优化</h3><p> 默认的Linux内核参数考虑的是最通用的场景，不符合用于支持高并发访问的Web服务器的定义，所以需要修改Linux内核参数，使得Nginx可以拥有更高的性能。</p>
<p>内核优化基本上会根据业务特点来进行调整，当Nginx作为静态Web内容服务器、反向代理服务器或是提供图片缩略功能（实时压缩图片）的服务器时，其内核参数的调整都是不同的。这里只针对最通用的、使Nginx支持更多并发请求的TCP网络参数做简单说明。</p>
<p> 首先，需要修改&#x2F;etc&#x2F;sysctl.conf来更改内核参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_max_tw_buckets = 6000   timewait 的数量，默认是180000。</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000   允许系统打开的端口范围。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1   启用timewait 快速回收。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1   开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_syncookies = 1   开启SYN Cookies，当出现SYN 等待队列溢出时，启用cookies 来处理。</span><br><span class="line"></span><br><span class="line">net.core.somaxconn = 262144web   应用中listen 函数的backlog 默认会给我们内核参数的net.core.somaxconn 限制到128，而nginx 定义的NGX_LISTEN_BACKLOG 默认为511，所以有必要调整这个值。</span><br><span class="line"></span><br><span class="line">net.core.netdev_max_backlog = 262144   每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_orphans = 262144   系统中最多有多少个TCP 套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS 攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144   记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有128M 内存的系统而言，缺省值是1024，小内存的系统则是128。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_timestamps = 0   时间戳可以避免序列号的卷绕。一个1Gbps 的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常”的数据包。这里需要将其关掉。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_synack_retries = 1   为了打开对端的连接，内核需要发送一个SYN 并附带一个回应前面一个SYN 的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK 包的数量。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_syn_retries = 1   在内核放弃建立连接之前发送SYN 包的数量。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fin_timeout = 1   如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2 状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是60 秒。2.2 内核的通常值是180 秒，3你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB 服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2 的危险性比FIN-WAIT-1 要小，因为它最多只能吃掉1.5K 内存，但是它们的生存期长些。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = 30   当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时。</span><br></pre></td></tr></table></figure>

<p> 下面贴一个完整的内核优化设置:</p>
<p> vi &#x2F;etc&#x2F;sysctl.conf CentOS5.5中可以将所有内容清空直接替换为如下内容:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 1</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line">kernel.sysrq = 0</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 4194304</span><br><span class="line">net.ipv4.tcp_wmem = 4096 16384 4194304</span><br><span class="line">net.core.wmem_default = 8388608</span><br><span class="line">net.core.rmem_default = 8388608</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.core.netdev_max_backlog = 262144</span><br><span class="line">net.core.somaxconn = 262144</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class="line">net.ipv4.tcp_fin_timeout = 1</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br></pre></td></tr></table></figure>

<p>使配置立即生效可使用如下命令： &#x2F;sbin&#x2F;sysctl -p</p>
<h1 id="四、Nginx负载均衡"><a href="#四、Nginx负载均衡" class="headerlink" title="四、Nginx负载均衡"></a>四、Nginx负载均衡</h1><h2 id="1、四层和七层"><a href="#1、四层和七层" class="headerlink" title="1、四层和七层"></a>1、四层和七层</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1）四层负载</span><br><span class="line">四层就是基于IP+端口的负载均衡，通过虚拟IP+端口接收请求，然后再分配到真实的服务器；</span><br><span class="line"></span><br><span class="line">2）七层负载</span><br><span class="line">七层就是基于URL等应用层信息的负载均衡，通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。</span><br><span class="line"></span><br><span class="line">3）二层、三层负载</span><br><span class="line">基于MAC地址的二层负载均衡：二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；</span><br><span class="line">基于IP地址的三层负载均衡：三层负载均衡会通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址；</span><br></pre></td></tr></table></figure>



<h2 id="2、热备"><a href="#2、热备" class="headerlink" title="2、热备"></a>2、热备</h2><p>如果你有2台服务器，当一台服务器发生事故时，才启用第二台服务器给提供服务。服务器处理请求的顺序：AAAAAA突然A挂啦，BBBBBBBBBBBBBB…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream mysvr &#123; </span><br><span class="line"> server 127.0.0.1:7878; </span><br><span class="line"> server 192.168.10.121:3333 backup; #热备 </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="3、负载均衡策略（算法）"><a href="#3、负载均衡策略（算法）" class="headerlink" title="3、负载均衡策略（算法）"></a>3、负载均衡策略（算法）</h2><p>Nginx 默认提供的负载均衡策略：</p>
<p><strong>1）轮询（默认）round_robin</strong></p>
<p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<p>虽然这种方式简便、成本低廉。但缺点是：可靠性低和负载分配不均衡。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backserver &#123; </span><br><span class="line">	server 192.168.0.14; </span><br><span class="line">	server 192.168.0.15; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p><strong>2）权重 weight</strong></p>
<p>weight的值越大分配到的访问概率越高，主要用于后端每台服务器性能不均衡的情况下，达到合理的资源利用率。</p>
<p>配置方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backserver &#123; </span><br><span class="line">	server 192.168.0.14 weight=8; </span><br><span class="line">	server 192.168.0.15 weight=10; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p><strong>3）IP 哈希 ip_hash</strong></p>
<p>ip_hash： 来自同一个IP的请求会分发到相同的后端服务器</p>
<p>每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 共享的问题。</p>
<p>当然，实际场景下，一般不考虑使用 ip_hash 解决 session 共享。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backserver &#123; </span><br><span class="line">	ip_hash; </span><br><span class="line">	server 192.168.0.14:88; </span><br><span class="line">	server 192.168.0.15:80; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p><strong>4）最少连接 least_conn</strong></p>
<p>把请求转发给连接数较少的后端服务器。轮询算法是把请求平均的转发给各个后端，使它们的负载大致相同；但是，有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn这种方式就可以达到更好的负载均衡效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#动态服务器组</span><br><span class="line">    upstream backserver &#123;</span><br><span class="line">        least_conn;    #把请求转发给连接数较少的后端服务器</span><br><span class="line">        server localhost:8080   weight=2;  #tomcat 7.0</span><br><span class="line">        server localhost:8081;  #tomcat 8.0</span><br><span class="line">        server localhost:8082 backup;  #tomcat 8.5</span><br><span class="line">        server localhost:8083   max_fails=3 fail_timeout=20s;  #tomcat 9.0</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>5）fair（第三方）</strong><br>按后端服务器的响应时间来分配请求，响应时间短的优先分配。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backserver &#123; </span><br><span class="line">	server server1; </span><br><span class="line">	server server2; </span><br><span class="line">	fair; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p><strong>6）url_hash（第三方）</strong><br>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backserver &#123; </span><br><span class="line">	server squid1:3128; </span><br><span class="line">	server squid2:3128; </span><br><span class="line">	hash $request_uri; </span><br><span class="line">	hash_method crc32; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>补充：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sticky：通过nginx-sticky模块，来实现cookie黏贴的方式将来自同一个客户端的请求发送到同一个后端服务器上处理，这样一定程度上可以解决多个后端服务器的session会话同步的问题；</span><br><span class="line">round-robin（RR）：轮询，每个请求按时间顺序依次分配到不同的后端服务器，如果后端某台服务器死机，自动剔除故障系统，使用户访问不受影响；</span><br><span class="line">weight：轮询权重，weight的值越大分配到的访问概率就越高，主要用于后端每台服务器性能不均衡的情况下，或者仅仅为在主从的情况下设置不同的权重，达到合理有效的利用主机资源。</span><br><span class="line">least_conn：请求被发送到当前活跃连接最少的realserver上，会考虑到weight的值；</span><br><span class="line">ip_hash：每个请求按照IP的哈希结果分配，使来自同一个IP的访客固定访问后端服务器，可以有效的解决动态网页存在的session共享问题。</span><br><span class="line">fair：比weight、ip_hash更加智能的负载均衡算法，fair算法可以根据页面的大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，相应时间短的优先分配。nginx本身不支持fair，如果需要使用这种调度算法，则必须安装upstream_fair模块。</span><br><span class="line">url_hash：按访问的URL的哈希结果来分配请求，使每个URL定向到后端服务器，可以进一步提高后端缓存服务器的效率。同样，nginx本身不支持url_hash，如果需要这种调度算法，则必须安装nginx的hash软件包。</span><br></pre></td></tr></table></figure>

<h2 id="4、负载均衡状态"><a href="#4、负载均衡状态" class="headerlink" title="4、负载均衡状态"></a>4、负载均衡状态</h2><p>在nginx upstream模块中，可以设定每台后端服务器在负载均衡调度中的状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常用的状态有：</span><br><span class="line"></span><br><span class="line">down：表示当前的server暂时不参与负载均衡；</span><br><span class="line">backup：预留的备份机器。当其他所有的非backup机器出现故障或者繁忙的时候，才会请求backup机器，因此这台机器的访问压力最低；</span><br><span class="line">max_fails：允许请求失败的次数，默认为1，当超过最大次数时，返回proxy_next_upstraem模块定义的错误；</span><br><span class="line">fail_timeout：请求失败超时时间，在经历了max_fails次失败后，暂停服务的时间。max_fails和fail_timeout可以一起使用。</span><br></pre></td></tr></table></figure>



<h1 id="六、FastCG、php-fpm"><a href="#六、FastCG、php-fpm" class="headerlink" title="六、FastCG、php-fpm"></a>六、FastCG、php-fpm</h1><h2 id="1、Nginx-FastCGI运行原理"><a href="#1、Nginx-FastCGI运行原理" class="headerlink" title="1、Nginx+FastCGI运行原理"></a>1、Nginx+FastCGI运行原理</h2><p>Nginx 不支持对外部程序的直接调用或者解析，所有的外部程序（包括 PHP）必须通过FastCGI 接口来调用。FastCGI 接口在 Linux 下是 socket（这个 socket 可以是文件 socket， 也可以是 ip socket）。 wrapper 为了调用 CGI 程序，还需要一个 FastCGI 的 wrapper（wrapper 可以理解为用于启动另一个程序的程序），这个 wrapper 绑定在某个固定 socket 上，如端口或者文件 socket。当 Nginx 将 CGI 请求发送给这个 socket 的时候，通过 FastCGI 接口，wrapper 接收到请求，然后 Fork(派生）出一个新的线程，这个线程调用解释器或者外部程序处理脚本并读取返回数据；接着 wrapper 再将返回的数据通过 FastCGI 接口，沿着固定的 socket传递给 Nginx；最后 Nginx 将返回的数据（html 页面或者图片）发送给客户端。</p>
<h2 id="2、缺省安装的Nginx-php-fpm环境"><a href="#2、缺省安装的Nginx-php-fpm环境" class="headerlink" title="2、缺省安装的Nginx+php-fpm环境"></a>2、缺省安装的Nginx+php-fpm环境</h2><p>假设用户浏览一个耗时的网页，但是却在服务端渲染页面的中途中关闭了浏览器，那么请问服务端的PHP脚本是继续执行还是退出执行？</p>
<p>答：正常情况下，如果client异常退出了，Server端的程序还是会继续执行，直到与IO进行了两次交互操作。Server端发现client端已经断开连接，这个时候会出发一个User_abort，如果这个没有设置ignore_user_abort，那么这个php-fpm的程序才会被中断。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fpm模块，对接nginx处理动态请求，端口9000</span><br><span class="line"></span><br><span class="line">PHP-FPM(FastCGI Process Manager：FastCGI进程管理器)是一个PHPFastCGI管理器，对于PHP 5.3.3之前的php来说，是一个补丁包 [1] ，旨在将FastCGI进程管理整合进PHP包中。如果你使用的是PHP5.3.3之前的PHP的话，就必须将它patch到你的PHP源代码中，在编译安装PHP后才可以使用。</span><br><span class="line"></span><br><span class="line">相对Spawn-FCGI，PHP-FPM在CPU和内存方面的控制都更胜一筹，而且前者很容易崩溃，必须用crontab进行监控，而PHP-FPM则没有这种烦恼。</span><br></pre></td></tr></table></figure>

<h2 id="3、已知nginx和php-fpm安装在同一台服务器上，nginx连接php-fpm有两种方式：一种是类似127-0-0-1-9000的TCP-socket，另一种是类似-tmp-php-fpm-sock的Unix-domain-socket，请问如何选择？需要注意什么？"><a href="#3、已知nginx和php-fpm安装在同一台服务器上，nginx连接php-fpm有两种方式：一种是类似127-0-0-1-9000的TCP-socket，另一种是类似-tmp-php-fpm-sock的Unix-domain-socket，请问如何选择？需要注意什么？" class="headerlink" title="3、已知nginx和php-fpm安装在同一台服务器上，nginx连接php-fpm有两种方式：一种是类似127.0.0.1:9000的TCP socket，另一种是类似&#x2F;tmp&#x2F;php-fpm.sock的Unix domain socket，请问如何选择？需要注意什么？"></a>3、已知nginx和php-fpm安装在同一台服务器上，nginx连接php-fpm有两种方式：一种是类似127.0.0.1:9000的TCP socket，另一种是类似&#x2F;tmp&#x2F;php-fpm.sock的Unix domain socket，请问如何选择？需要注意什么？</h2><p>Unix domain socket的流程不会走到TCP那层，直接以文件的形式，以stream socket通信。如果是TCP Socket，则需要走到IP层。说的通俗一点，追求可靠性就是选择TCP（需要占用一个端口，更稳定，如：127.0.0.1:9000），追求高性能就是Unix Socket（不需要占用端口，更快，但可靠性不如TCP的方式）。</p>

    </div>
</article>


<div id="comments-template"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script>
	if(!window.commentConfig) {
      window.commentConfig = {}
      window.commentConfig.title = 'Nginx'
    }
</script>

                </div>
                <aside class="col-md-4 gal-left" id="sidebar">
    <!-- 此为sidebar的搜索框, 非搜索结果页面 -->
<aside id="sidebar-search">
    <div class="search hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <form class="form-inline clearfix" id="search-form" method="get"
              action="/search/index.html">
            <input type="text" name="s" class="form-control" id="searchInput" placeholder="搜索文章~" autocomplete="off">
            <button class="btn btn-danger btn-gal" type="submit">
                <i class="fa fa-search"></i>
            </button>
        </form>
    </div>
</aside>
    <aside id="sidebar-author">
    <div class="panel panel-gal" data-aos="flip-right" data-aos-duration="3000">
        <div class="panel-heading" style="text-align: center">
            <i class="fa fa-quote-left"></i>
            lzq
            <i class="fa fa-quote-right"></i>
        </div>
        <div class="author-panel text-center">
            <img src="/imgs/avatar.jpg" width="140" height="140"
                 alt="个人头像" class="author-image">
            <p class="author-description"></p>
        </div>
    </div>
</aside>
    
    <aside id="sidebar-recent_comments">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-comments"></i>
            最新评论
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush"></ul>
    </div>
</aside>
    
    <!-- 要配置好leancloud才能开启此小工具 -->
    
    
    <aside id="sidebar-recent_posts">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-refresh"></i>
            近期文章
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush">
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/13/Python-100-Days-master/Day91-100/95.%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/">Django开发商业项目</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/13/Python-100-Days-master/Day46-60/46.Django%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">Django快速上手</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Python%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8-%E5%9F%BA%E7%A1%80%E7%AF%87-2020/">Python基础题</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E8%8B%B1%E8%AF%AD%E9%9D%A2%E8%AF%95/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E7%9F%A5%E4%B9%8E%E9%97%AE%E9%A2%98%E5%9B%9E%E7%AD%94/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E7%94%A8%E5%87%BD%E6%95%B0%E8%BF%98%E6%98%AF%E7%94%A8%E5%A4%8D%E6%9D%82%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E7%8E%A9%E8%BD%ACPyCharm/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E5%8F%82%E8%80%83%E7%A4%BA%E4%BE%8B/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9%E4%BA%86Python/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/%E7%95%AA%E5%A4%96%E7%AF%87/%E5%B8%B8%E8%A7%81%E5%8F%8D%E7%88%AC%E7%AD%96%E7%95%A5%E5%8F%8A%E5%BA%94%E5%AF%B9%E6%96%B9%E6%A1%88/"></a>
                </span>
            </li>
            
        </ul>
    </div>
</aside>
    
    
    <aside id="sidebar-rand_posts">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-refresh"></i>
            随机文章
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush">
            
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/06/14/%E6%80%BB%E7%BB%93/Jenkins%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/">Jenkins详细教程</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day81-90/90.PyTorch%E5%AE%9E%E6%88%98/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day91-100/91.%E5%9B%A2%E9%98%9F%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day91-100/96.%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day21-30/code/%E5%9E%83%E5%9C%BE%E5%88%86%E7%B1%BB%E6%9F%A5%E8%AF%A2/index/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day21-30/code/new/web1901/example_of_audio_video/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day21-30/code/new/web1901/example_of_css_5/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day21-30/code/new/web1901/example_of_jquery_5/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day21-30/code/new/web1901/example_of_js_7/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2024/12/12/Python-100-Days-master/Day21-30/code/new/web1901/index/"></a>
                </span>
            </li>
            
        </ul>
    </div>
</aside>
    
    
    <aside id="gal-sets">
        <div class="panel panel-gal hidden-xs" data-aos="fade-up" data-aos-duration="2000">
            <ul class="nav nav-pills pills-gal">

                
                <li>
                    <a href="/2024/06/13/%E6%80%BB%E7%BB%93/8%E3%80%81Nginx/index.html#sidebar-tags" data-toggle="tab" id="tags-tab">热门标签</a>
                </li>
                
                
                <li>
                    <a href="/2024/06/13/%E6%80%BB%E7%BB%93/8%E3%80%81Nginx/index.html#sidebar-friend-links" data-toggle="tab" id="friend-links-tab">友情链接</a>
                </li>
                
                
                <li>
                    <a href="/2024/06/13/%E6%80%BB%E7%BB%93/8%E3%80%81Nginx/index.html#sidebar-links" data-toggle="tab" id="links-tab">个人链接</a>
                </li>
                
            </ul>
            <div class="tab-content">
                
                <div class="cloud-tags tab-pane nav bs-sidenav fade" id="sidebar-tags">
    
    <a href="/tags/Python/" style="font-size: 9.064440126031668px;" class="tag-cloud-link">Python</a>
    
    <a href="/tags/Apache/" style="font-size: 8.361887495831674px;" class="tag-cloud-link">Apache</a>
    
    <a href="/tags/Shell/" style="font-size: 16.15868865885878px;" class="tag-cloud-link">Shell</a>
    
    <a href="/tags/Linux/" style="font-size: 8.242049228092101px;" class="tag-cloud-link">Linux</a>
    
    <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 12.865624142290088px;" class="tag-cloud-link">网络</a>
    
    <a href="/tags/Ceph/" style="font-size: 16.288230163289374px;" class="tag-cloud-link">Ceph</a>
    
    <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" style="font-size: 12.731705240490808px;" class="tag-cloud-link">阿里云</a>
    
    <a href="/tags/%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/" style="font-size: 10.324306341092466px;" class="tag-cloud-link">灰度发布</a>
    
    <a href="/tags/MySQL/" style="font-size: 8.66292670697231px;" class="tag-cloud-link">MySQL</a>
    
    <a href="/tags/K8s/" style="font-size: 8.163786751098385px;" class="tag-cloud-link">K8s</a>
    
    <a href="/tags/KVM/" style="font-size: 16.94794755275612px;" class="tag-cloud-link">KVM</a>
    
    <a href="/tags/OpenStack/" style="font-size: 17.489989474031667px;" class="tag-cloud-link">OpenStack</a>
    
    <a href="/tags/Ansible/" style="font-size: 9.88222030949856px;" class="tag-cloud-link">Ansible</a>
    
    <a href="/tags/ELK/" style="font-size: 11.29391094335951px;" class="tag-cloud-link">ELK</a>
    
    <a href="/tags/Docker/" style="font-size: 17.961895556580853px;" class="tag-cloud-link">Docker</a>
    
    <a href="/tags/Radis%E3%80%81Mongodb/" style="font-size: 11.021041140136628px;" class="tag-cloud-link">Radis、Mongodb</a>
    
    <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 14.406049410071304px;" class="tag-cloud-link">负载均衡</a>
    
    <a href="/tags/Nginx/" style="font-size: 13.007005643360335px;" class="tag-cloud-link">Nginx</a>
    
    <a href="/tags/Tomcat/" style="font-size: 11.128721181942446px;" class="tag-cloud-link">Tomcat</a>
    
    <a href="/tags/DevOps/" style="font-size: 13.12833967639574px;" class="tag-cloud-link">DevOps</a>
    
    <a href="/tags/Jenkins/" style="font-size: 11.748924792584457px;" class="tag-cloud-link">Jenkins</a>
    
    <a href="/tags/Prometheus/" style="font-size: 12.522691146841188px;" class="tag-cloud-link">Prometheus</a>
    
    <a href="/tags/Django/" style="font-size: 10.29798953904108px;" class="tag-cloud-link">Django</a>
    
    <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 12.665539072602975px;" class="tag-cloud-link">爬虫</a>
    
    <a href="/tags/Selenium/" style="font-size: 14.430977637726091px;" class="tag-cloud-link">Selenium</a>
    
    <a href="/tags/Scrapy/" style="font-size: 12.148005975695423px;" class="tag-cloud-link">Scrapy</a>
    
</div>
                
                
                <div class="friend-links tab-pane nav bs-sidenav fade" id="sidebar-friend-links">
    
    <li>
        <a href="https://www.runoob.com/" target="_blank">菜鸟教程</a>
    </li>
    
    <li>
        <a href="https://www.csdn.net/" target="_blank">CSDN</a>
    </li>
    
    <li>
        <a href="https://nowcoder.com/" target="_blank">牛客网</a>
    </li>
    
    <li>
        <a href="https://www.bilibili.com/" target="_blank">B站</a>
    </li>
    
    <li>
        <a href="https://leetcode-cn.com/" target="_blank">Leetcode</a>
    </li>
    
    <li>
        <a href="https://www.heroku.com/" target="_blank">Heroku</a>
    </li>
    
</div>
                
                
                <div class="links tab-pane nav bs-sidenav fade" id="sidebar-links">
    
    <li>
        <a href="https://github.com/lzq2024/" target="_blank">Github</a>
    </li>
    
    <li>
        <a href="https://gitee.com/lzq2024" target="_blank">Gitee</a>
    </li>
    
    <li>
        <a href="https://www.zhihu.com/people/yr1d3j/activities" target="_blank">知乎</a>
    </li>
    
</div>
                
            </div>
        </div>
    </aside>
    
</aside>
            </div>
        </div>
    </div>
    <footer id="gal-footer">
    <div class="container">
        Copyright © 2018 lzq Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.&nbsp;Theme by <a href="https://github.com/Lzq2024" target="_blank">AONOSORA</a>
    </div>
</footer>

<!-- 回到顶端 -->
<div id="gal-gotop">
    <i class="fa fa-angle-up"></i>
</div>
</body>

<script src="/js/activate-power-mode.js"></script>

<script>

    // 配置highslide
	hs.graphicsDir = '/js/highslide/graphics/'
    hs.outlineType = "rounded-white";
    hs.dimmingOpacity = 0.8;
    hs.outlineWhileAnimating = true;
    hs.showCredits = false;
    hs.captionEval = "this.thumb.alt";
    hs.numberPosition = "caption";
    hs.align = "center";
    hs.transitions = ["expand", "crossfade"];
    hs.lang.number = '共%2张图, 当前是第%1张';
    hs.addSlideshow({
      interval: 5000,
      repeat: true,
      useControls: true,
      fixedControls: "fit",
      overlayOptions: {
        opacity: 0.75,
        position: "bottom center",
        hideOnMouseOut: true
      }
    })

    // 初始化aos
    AOS.init({
      duration: 1000,
      delay: 0,
      easing: 'ease-out-back'
    });

</script>
<script>
	POWERMODE.colorful = 'true';    // make power mode colorful
	POWERMODE.shake = 'true';       // turn off shake
	// TODO 这里根据具体情况修改
	document.body.addEventListener('input', POWERMODE);
</script>
<script>
    window.slideConfig = {
      prefix: '/imgs/slide/background',
      ext: 'jpg',
      maxCount: '7'
    }
</script>

<script src="/js/hs.js"></script>
<script src="/js/blog.js"></script>



<script src="/js/oni.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  if(window.commentConfig) {
     window.commentConfig.client_id = 'Ov23lijIsO699goQayhr'
     window.commentConfig.client_secret = 'd4e885f9aa839494f3927fd3fb244c2794e471a8'
     window.commentConfig.owner = 'Lzq2024'
     window.commentConfig.repo = 'gitalk'
     window.commentConfig.id = 'Thu Jun 13 2024 00:00:00 GMT+0800'
   } else {
    window.commentConfig = {
 	client_id: 'Ov23lijIsO699goQayhr',
 	client_secret: 'd4e885f9aa839494f3927fd3fb244c2794e471a8',
	owner: 'Lzq2024',
	repo: 'gitalk',
	id: 'Thu Jun 13 2024 00:00:00 GMT+0800'
      }
   }
</script>

<script src="/js/comment/gitment.js"></script>


</html>